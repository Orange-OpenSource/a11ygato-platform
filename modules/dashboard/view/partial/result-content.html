{{!
@a11ygato/dashboard
Copyright (C) 2018 Orange

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
}}

{{!
This file is part of pa11y-dashboard.

pa11y-dashboard is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

pa11y-dashboard is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with pa11y-dashboard.  If not, see <http://www.gnu.org/licenses/>.
}}

<script src="/flot.min.js?v={{version}}" defer></script>
<script>loadCSS('/bootstrap-table.min.css?v={{version}}');</script>
<script src="/bootstrap-table.min.js?v={{version}}" defer></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Bootstrap table options
        var commonOptions = {
            pagination:false,
            search:true,
            showColumns:true,
            rememberOrder:true,
            showMultiSort:true
        };
        var urlOptions    = {
            idField:'url',
            onSort:function(){ gtag('event', 'sort result urls', {'event_category': 'feature'}); },
            onSearch:function(){ gtag('event', 'filter result urls', {'event_category': 'feature'}); }
        };
        var errorOptions  = {
            detailView:true,
            detailFormatter:function detailFormatter(index, row) {
                return document.getElementById(row.rule).innerHTML;
            },
            idField:'rule',
            onClickRow:function onClickRow(row, element) {
                element.find('.detail-icon').triggerHandler('click');
            },
            onSort:function(){ gtag('event', 'sort result errors', {'event_category': 'feature'}); },
            onSearch:function(){ gtag('event', 'filter result errors', {'event_category': 'feature'}); }
        };

        // Create references to jQuery elements
        var $urlsTable   = $('#urls-result-table');
        var $errorsTable = $('#errors-result-table');

        // Initialize each table with the bootstrap-table plugin
        $urlsTable.bootstrapTable(Object.assign(commonOptions, urlOptions));
        $errorsTable.bootstrapTable(Object.assign(commonOptions, errorOptions));

        // If the window's width change, we will adapt. This is a javascript media query.
        // 480px correspond to xs size in bootstrap responsive ecosystem.
        var mediaQueryList = window.matchMedia("(max-width:480px)");
        mediaQueryList.addListener(handleResize);
        handleResize(mediaQueryList); // Initialize with current situation

        function handleResize(event) {
            if(event.matches){
                // First table
                $urlsTable.bootstrapTable('hideColumn', 'errors');
                $urlsTable.bootstrapTable('hideColumn', 'elements');
                // Second table
                $errorsTable.bootstrapTable('hideColumn', 'rule');
            }
            else{
                // First table
                $urlsTable.bootstrapTable('showColumn', 'errors');
                $urlsTable.bootstrapTable('showColumn', 'elements');
                // Second table
                $errorsTable.bootstrapTable('showColumn', 'rule');
            }
        }

        // Add a label with javascript cause these input fields are generated by the bootstrap-table library.
        // Improve accessibility score.
        document.querySelectorAll('.bootstrap-table .fixed-table-toolbar .search input')
            .forEach(function(input){ input.setAttribute('aria-label', 'Search input for filtering') });

    }, { passive:true });
</script>

<div id="top" class="col-xs-12 flex-container flex-container--cross-start">
    {{#if results}}
    {{> result-selector}}
    {{/if}}
    {{#mainResult}}
    <div class="task-stats flex-container flex-container--end">
        <a class="warning task-stats__item" href="#errors" title="See errors">{{kpi}}<span class="stat-type">KPI</span></a>
        <a class="danger task-stats__item" href="#errors" title="See errors">{{count.error}}<span class="stat-type">Errors</span></a>
        <a class="info last task-stats__item" href="#errors" title="See errors">{{numElements}}<span class="stat-type">Elements</span></a>
    </div>
    {{/mainResult}}
</div>
{{!--
<!--Doesn't work it seems so it should not be visible-->
<!--<div class="action-buttons col-xs-12 clearfix">-->
<!--<div class="row">-->
<!--<div class="col-xs-12">-->
<!--<a href="{{mainResult.hrefCsv}}" class="btn-full-width btn btn-default" data-test="download-csv">-->
<!--Download CSV <span class="glyphicon glyphicon-download"></span>-->
<!--</a>-->
<!--</div>-->
<!--<div class="col-xs-12">-->
<!--<a href="{{mainResult.hrefJson}}" class="btn-full-width btn btn-default" data-test="download-json">-->
<!--Download JSON <span class="glyphicon glyphicon-download"></span>-->
<!--</a>-->
<!--</div>-->
<!--</div>-->
<!--</div>-->
--}}
<div class="col-xs-12">
    {{#mainResult}}
    <div class="heading showing label-info" id="notices" data-test="task-notices">
        <span data-role="expander" class="pull-right expander">—</span>
        {{urls.length}} URL(s)
    </div>
    {{/mainResult}}

    <div class="zone-info zone collapse clearfix in">

        {{#if mainResult.exception}}
        <p class="error-url"><strong>Error :</strong> {{mainResult.exception}}</p>
        {{else}}
        <table id="urls-result-table" class="table table-condensed table-hover table-striped table-responsive table-bordered">
            <thead>
            <tr>
                <th data-field="kpi" data-sortable="true" data-align="right"
                    data-title-tooltip="Computed score for the page based on number of errors and elements">KPI
                </th>
                <th data-field="errors" data-sortable="true" data-align="right" data-title-tooltip="Number of detected errors in page">Errors</th>
                <th data-field="elements" data-sortable="true" data-align="right" data-title-tooltip="Number of elements in page">Elements</th>
                <th data-field="url" data-sortable="true" data-title-tooltip="URL of the page">URL</th>
            </tr>
            </thead>
            <tbody>
            {{#mainResult.urls}}
            <tr>
                <td>{{kpi}}</td>
                <td>{{count.error}}</td>
                <td>{{numElements}}</td>
                <td>
                    <a href="{{url}}" title="Details results for {{original}}" class="task-url {{ternary hasError 'error-url' ''}}">{{original}}</a>
                    {{#if exception}}
                    <p><strong>Error :</strong> {{exception}}</p>
                    {{/if}}
                </td>
            </tr>
            {{/mainResult.urls}}
            </tbody>
        </table>
        {{/if}}

        <a class="pull-right" href="#top" data-role="top">Back to top</a>
    </div>


    {{#if mainResult.count.error }}
    <div class="heading label-danger showing first" id="errors" data-test="task-errors">
        <span data-role="expander" class="pull-right expander">—</span>
        {{mainResult.count.error}} Errors
    </div>
    <div class="zone-danger zone collapse clearfix in">

        <table id="errors-result-table" class="table table-condensed table-hover table-striped table-responsive table-bordered row-expandable">
            <thead>
            <tr>
                <th data-field="rule" data-sortable="true" data-align="left" data-title-tooltip="Rule name in WCAG specification">Rule</th>
                {{#if showImpactColumn}}
                    <th data-field="impact" data-sortable="true" data-align="center" data-title-tooltip="Criticality">Impact</th>
                {{/if}}
                <th data-field="occurence" data-sortable="true" data-align="right" data-title-tooltip="Number of occurences in page">Count</th>
                <th data-field="description" data-sortable="true" data-align="left" data-title-tooltip="Quick explanation">Quick explanation</th>
            </tr>
            </thead>
            <tbody>
            {{#mainResult.errors}}
            <tr>
                <td>{{code}}</td>
                {{#if ../showImpactColumn}}<td>{{impact}}</td>{{/if}}
                <td>{{count}}</td>
                <td>
                    {{#if helpUrl}}
                    <a class="text-hint" href="{{helpUrl}}" target="_blank" rel="noopener">{{message}}</a>
                    {{else}}
                    <span class="text-hint">{{message}}</span>
                    {{/if}}
                </td>
            </tr>
            {{/mainResult.errors}}
            </tbody>
        </table>
        {{#mainResult.errors}}
            <template id="{{code}}">
                <p>Detected in URLs:</p>
                <ul>
                    {{#urls}}
                    <li class="rule-url__value">
                        <a href="{{url}}">{{original}}</a>
                    </li>
                    {{/urls}}
                </ul>
            </template>
        {{/mainResult.errors}}
        <a class="pull-right" href="#top" data-role="top">Back to top</a>
    </div>
    {{/if}}

</div>

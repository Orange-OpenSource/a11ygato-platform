{{!
@a11ygato/dashboard
Copyright (C) 2018 Orange

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
}}

{{!
This file is part of pa11y-dashboard.

pa11y-dashboard is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

pa11y-dashboard is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with pa11y-dashboard.  If not, see http://www.gnu.org/licenses.
}}

<script src="/flot.min.js?v={{version}}" defer></script>
<script>loadCSS('/bootstrap-table.min.css?v={{version}}');</script>
<script src="/bootstrap-table.min.js?v={{version}}" defer></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var errorOptions  = {
            pagination:false,
            search:true,
            showColumns:true,
            rememberOrder:true,
            showMultiSort:true,
            idField:'rule',
            onSort:function(){ gtag('event', 'sort result errors', {'event_category': 'feature'}); },
            onSearch:function(){ gtag('event', 'filter result errors', {'event_category': 'feature'}); }
        };

        // Create references to jQuery elements
        var $errorsTable = $('#errors-result-table');

        // Initialize each table with the bootstrap-table plugin
        $errorsTable.bootstrapTable(errorOptions);

        // If the window's width change, we will adapt. This is a javascript media query.
        // 480px correspond to xs size in bootstrap responsive ecosystem.
        var mediaQueryList = window.matchMedia("(max-width:480px)");
        mediaQueryList.addListener(handleResize);
        handleResize(mediaQueryList); // Initialize with current situation

        function handleResize(event) {
            if(event.matches){
                $errorsTable.bootstrapTable('hideColumn', 'rule');
            }
            else{
                $errorsTable.bootstrapTable('showColumn', 'rule');
            }
        }

        // Add a label with javascript cause these input fields are generated by the bootstrap-table library.
        // Improve accessibility score.
        document.querySelectorAll('.bootstrap-table .fixed-table-toolbar .search input')
            .forEach(function(input){ input.setAttribute('aria-label', 'Search input for filtering') });

    }, { passive:true });
</script>
<div class="col-xs-12 no-graph">
    <h2 class="h4 break-all">Audited URI : {{mainResult.original}}</h2>
</div>
<div id="top" class="col-xs-12 flex-container flex-container--cross-start">
    <div class="action-buttons">
        <a href="{{mainResult.hrefPng}}" class="btn-full-width btn btn-default" title="Open screenshot (png) (new window)" target="_blank"
           rel="noopener" onclick="javascript:gtag('event', 'download url screenshot', {'event_category': 'feature'})">Open screenshot (png)</a>
    </div>
    {{#mainResult}}
    <div class="task-stats flex-container flex-container--end">
        <a class="warning task-stats__item" title="See errors">{{kpi}}<span class="stat-type">KPI</span></a>
        <a class="danger task-stats__item" title="See errors">{{count.error}}<span class="stat-type">Errors</span></a>
        <a class="info last task-stats__item" title="See errors">{{numElements}}<span class="stat-type">Elements</span></a>
    </div>
    {{/mainResult}}
</div>
<div class="col-xs-12">
    {{#if mainResult.count.error}}
        <div class="heading label-danger showing first" data-test="task-errors">
            <span data-role="expander" class="pull-right expander"> â€” </span>
            Errors ( {{mainResult.count.error}} )
        </div>
        <div class="zone-danger zone collapse clearfix in">

            <table id="errors-result-table" class="table table-condensed table-hover table-striped table-responsive table-bordered">
                <thead>
                <tr>
                    <th data-field="rule" data-sortable="true" data-align="left" data-title-tooltip="Rule name in WCAG specification">Rule</th>
                    {{#if showImpactColumn}}
                        <th data-field="impact" data-sortable="true" data-align="center" data-title-tooltip="Criticality">Impact</th>
                    {{/if}}
                    <th data-field="occurence" data-sortable="true" data-align="right" data-title-tooltip="Number of occurences in page">Count</th>
                    <th data-field="description" data-sortable="true" data-align="left" data-title-tooltip="Quick explanation">Quick explanation</th>
                </tr>
                </thead>
                <tbody>
                {{#mainResult.errors}}
                <tr>
                    <td>{{code}}</td>
                    {{#if ../showImpactColumn}}<td>{{impact}}</td>{{/if}}
                    <td>{{count}}</td>
                    <td>
                        {{#if helpUrl}}
                        <a class="text-hint" href="{{helpUrl}}" target="_blank" rel="noopener">{{message}}</a>
                        {{else}}
                        <span class="text-hint">{{message}}</span>
                        {{/if}}
                    </td>
                </tr>
                {{/mainResult.errors}}
                </tbody>
            </table>
            <a class="pull-right" href="#top" data-role="top">Back to top</a>
        </div>
    {{/if}}
    {{#if mainResult.exception}}
        <p class="heading label-danger"><strong>Error :</strong> {{mainResult.exception}}</p>
    {{/if}}
</div>
